# Belyfted Multicurrency Wallet & Account Management System Technical Documentation

## Table of Contents
1. [Overview](#overview)
2. [System Architecture](#system-architecture)
3. [Database Schemas](#database-schemas)
4. [Account Types](#account-types)
5. [User Journeys](#user-journeys)
6. [Admin Management](#admin-management)
7. [API Endpoints](#api-endpoints)
8. [Frontend Components](#frontend-components)

---

## Overview

This system provides a comprehensive wallet and account management solution integrated with ClearBank. It enables users to create and manage wallets, real accounts, and virtual accounts in multiple currencies.

### Key Features
- Multi-currency wallet support (USD, GBP, EUR, etc.)
- Real and virtual account management
- Admin approval workflow for account creation
- Integration with ClearBank for banking operations
- Transaction tracking and statement generation
- Balance management with segregation options

---

## System Architecture

### Account Hierarchy
```
Wallet (1:1) → Real Account (held with ClearBank)
                    ↓
              Virtual Accounts (multiple, held on platform)
```

**Important Rules:**
- Each user can have **one Real Account** per wallet
- Each user can create **multiple Virtual Accounts** under a Real Account
- Virtual accounts use funds from their associated Real Account
- Real Account balances are reconciled by ClearBank

---

## Database Schemas

### Wallet Schema
```sql
wallet {
  uuid: string (primary key)
  user_id: string
  ledger_balance: decimal
  available_balance: decimal
  locked_balance: decimal
  rolling_reserve_balance: decimal
  currency: string
  approval_status: integer
    -- 0: Approved
    -- 1: Rejected
    -- 2: Pending
  status: enum
    -- 'disabled'
    -- 'enabled'
  lock: integer
    -- 0: wallet unlocked
    -- 1: wallet locked
  real_account_id: string
  wallet_type: string
}
```

### Virtual Accounts Schema
```sql
virtual_accounts {
  uuid: string (primary key)
  user_id: string
  approval_status: integer
    -- 0: Approved
    -- 1: Rejected
    -- 2: Pending
  account_id: string
  currency: string
  account_name: string
  account_holder_label: string
  account_identifiers: json {
    "IBAN": "GB00CUBK11223312345678",
    "BBAN": "CUBK11223312345678"
  }
  external_identifiers: json
  timestamp_created: timestamp
  webhook_response_type: string
  balance: decimal
  metadata: json
}
```

### Real Accounts Schema
```sql
real_accounts {
  uuid: string (primary key)
  user_id: string
  account_id: string
  currency: string
  account_name: string
  account_holder_label: string
  account_identifiers: json {
    "IBAN": "GB00CUBK11223312345678",
    "BBAN": "CUBK11223312345678"
  }
  account_type: string
  legal_owner_type: enum
    -- 'Personal'
    -- 'Business'
  relationship_type: enum
    -- 'Single'
    -- 'Joint' (not allowed if legal_owner_type is Business)
  webhook_response_type: string
  balance: decimal
  metadata: json
}
```

---

## Account Types

### Real Accounts
- **Provider**: Held with ClearBank
- **Reconciliation**: Balances reconciled by ClearBank
- **Access**: Available via ClearBank Portal or API endpoints
- **Creation**: Using `POST /v3/Accounts` endpoint
- **Limit**: One per wallet per user

#### Real Account Types (Kind Field)
When creating multi-currency real accounts, select from:
- **YourFunds**: Your own operating funds
- **DesignatedSegregated**: Segregated funds for a single customer
- **GeneralSegregated**: Pooled segregated funds
- **DesignatedClient**: Client funds for a single customer
- **GeneralClient**: Pooled client funds

Each type receives an autogenerated prefix (e.g., 'Gen Seg').

### Virtual Accounts
- **Provider**: Held on platform (Belyfted)
- **Funds Location**: Stored in associated Real Account with ClearBank
- **Identifier**: Virtual IBAN (vIBAN)
- **Creation**: Must be created under a Real General (pooled) Account
- **Limit**: Multiple per Real Account

#### Virtual Account Features
- Use vIBAN to send and receive payments
- Funds drawn from associated Real Account
- Receive Transaction Settled webhooks for payments
- Balance reconciliation via webhook information

---

## User Journeys

### 1. Wallet Creation Journey

**User Steps:**
1. Navigate to "Create new wallet" page
2. Fill in basic information:
   - Account Type: Company or Personal
   - Account Currency: USD, GBP, EUR, etc.
   - Reason for creating the wallet
3. Submit request (status: Pending)

**Admin Steps:**
1. Review wallet creation request
2. Decision:
   - **Approve**: Real Account created for user, wallet becomes active
   - **Reject**: Wallet not created, user notified

**Result:**
- Approved wallet becomes user's Real Account
- User can now create Virtual Accounts under this wallet

### 2. Virtual Account Creation Journey

**User Steps:**
1. Navigate to "Create new virtual account" page
2. Select existing wallet
3. Fill in basic information:
   - Account Type: Company or Personal
   - Account Currency: USD, GBP, EUR, etc.
   - Reason for creating the account
4. Submit request (status: Pending)

**Admin Steps:**
1. Review virtual account creation request
2. Decision:
   - **Approve**: Virtual Account created under the Real Account
   - **Reject**: Virtual Account not created, user notified

---

## Admin Management

### Wallet Management

#### Capabilities
- View all wallets (Approved, Pending, Rejected)
- Approve or reject wallet creation requests
- Lock or unlock wallets
- Enable or disable wallets
- Configure supported wallet currencies

#### Wallet Status Management
```
lock: 0 = unlocked, 1 = locked
status: enabled / disabled
approval_status: 0 = Approved, 1 = Rejected, 2 = Pending
```

### Real Account Management

#### Core Operations
- Manage all Real Accounts
- Approve or reject Real Account creation requests
- Amend account status
- Retrieve account balances
- List all Virtual Accounts under a Real Account
- Retrieve transactions
- Request account statements

#### Account Status Options
- NotProvided
- Enabled
- Closed
- Suspended

#### Modifiable Properties
```
relationshipType: Single, Joint
  -- Note: Cannot be Joint if legalOwnerType is Business

legalOwnerType: Personal, Business

ownerName: Legal owner identification name
```

### Virtual Account Management

#### Core Operations
- Manage all Virtual Accounts
- Approve or reject Virtual Account creation requests
- Disable Virtual Accounts
- Retrieve transactions
- Modify account properties

#### Modifiable Properties
```
relationshipType: Single, Joint
  -- Note: Cannot be Joint if legalOwnerType is Business

legalOwnerType: Personal, Business

ownerName: Legal owner identification name
```

### Configuration Management

Admins can configure:
- Supported wallet currencies
- Supported Real Account currencies under wallets
- Supported Virtual Account currencies under wallets

---

## API Endpoints

### Real Accounts

#### Create Real Account
```http
POST /v3/Accounts
```
Creates a new real GBP account.

#### Get Account Balance
```http
GET /v3/Accounts/{accountId}
```
Retrieves balance and details for a specific Real Account.

#### List All Real Accounts
```http
GET /v3/Accounts
```
Retrieves all Real Accounts.

#### Amend Account Properties
```http
PATCH /v1/accounts/{accountId}
```
Updates properties of an existing Real Account (status, relationshipType, legalOwnerType, ownerName).

#### Get Account Transactions
```http
GET /mccy/v1/Accounts/{accountId}/transactions
```
Retrieves transactions for a Real Account and its associated Virtual Accounts.

#### Request Account Statement
```http
POST /mccy/v1/StatementRequests/account/{iban}
```
Generates a statement for the specified account.

### Virtual Accounts

#### List Virtual Accounts
```http
GET /v2/Accounts/{accountId}/Virtual
```
Lists all Virtual Accounts belonging to a given Real Account.

#### Disable Virtual Account
```http
DELETE /v1/accounts/{accountId}/virtual/{virtualAccountId}
```
Disables a specific Virtual Account.

#### Get Virtual Account Transactions
```http
GET /mccy/v1/VirtualAccounts/{virtualAccountId}/transactions
```
Retrieves transactions for a Virtual multi-currency account.

---

## Frontend Components

### User Pages/Screens

1. **Create New Wallet**
   - Form to input wallet details
   - Account type selection
   - Currency selection
   - Reason for creation

2. **Wallet Details**
   - Transaction history
   - Account details display
   - Statistics and analytics
   - List of additional accounts (Virtual Accounts)

3. **List All Wallets**
   - Filter by status: Pending, Rejected, Approved
   - Quick actions for each wallet
   - Status indicators

4. **Create New Virtual Account**
   - Select parent wallet
   - Account type selection
   - Currency selection
   - Reason for creation

5. **List All Virtual Accounts**
   - View all created Virtual Accounts
   - Filter and search capabilities
   - Status indicators

6. **Virtual Account Details**
   - Transaction history
   - Account details display
   - Statistics and analytics

### Admin Pages/Screens

1. **Wallet Management Dashboard**
   - Pending approval queue
   - Wallet status management
   - Lock/unlock controls

2. **Real Account Management**
   - Account approval workflow
   - Status amendment interface
   - Balance viewing
   - Transaction retrieval

3. **Virtual Account Management**
   - Virtual account approval workflow
   - Account disable controls
   - Transaction viewing

4. **Configuration Management**
   - Currency configuration
   - Account type settings
   - System-wide preferences

---

## Webhooks

### Transaction Settled Webhook
When a payment addressed to a Virtual Account settles, you receive a webhook notification containing:
- Virtual Account vIBAN
- Transaction details
- Settlement information

Use this data to reconcile Virtual Account balances.

---

## Business Rules

### Critical Constraints

1. **One Real Account Per User**: Each user can only have one Real Account tied to their wallet.

2. **Multiple Virtual Accounts**: Users can create multiple Virtual Accounts under their Real Account.

3. **Joint Account Restrictions**: If `legalOwnerType` is Business, then `relationshipType` cannot be Joint.

4. **Approval Workflow**: All wallet and account creation requests require admin approval before activation.

5. **Virtual Account Dependencies**: Virtual Accounts can only be created under approved Real Accounts.

6. **Fund Storage**: Virtual Account funds are physically stored in the parent Real Account held with ClearBank.

---

## Status Codes Reference

### Approval Status
- `0` - Approved
- `1` - Rejected
- `2` - Pending

### Wallet Lock Status
- `0` - Unlocked
- `1` - Locked

### Wallet Status
- `enabled` - Active and operational
- `disabled` - Inactive

### Real Account Status
- `NotProvided` - Status not specified
- `Enabled` - Active and operational
- `Closed` - Permanently closed
- `Suspended` - Temporarily suspended

---

## Integration Notes

### ClearBank Integration
- Real Accounts are created and managed through ClearBank
- Balance reconciliation handled by ClearBank
- Access to ClearBank Portal for account verification
- Multi-currency support through ClearBank infrastructure

### Platform Integration (Belyfted)
- Virtual Accounts managed on platform
- Webhook system for transaction notifications
- Balance tracking and reconciliation
- User interface for account management

---

## Support and Maintenance

### For Users
- Monitor wallet and account status through the dashboard
- Track transactions in real-time
- Receive notifications for approval status changes
- Access account statements through the platform

### For Administrators
- Regular review of pending approvals
- Monitor system configuration
- Manage currency support
- Oversee compliance with business rules

---

## Glossary

**Real Account**: A bank account held directly with ClearBank, tied to a user's wallet.

**Virtual Account**: A sub-account created under a Real Account, with its own vIBAN for receiving payments.

**vIBAN**: Virtual IBAN assigned to Virtual Accounts for payment processing.

**Wallet**: The primary container for a user's Real Account and associated Virtual Accounts.

**Segregated Account**: Account type that separates customer funds from operational funds.

**General Account**: Pooled account type that can hold funds for multiple customers.

**Legal Owner Type**: Classification of account ownership (Personal or Business).

**Relationship Type**: Operating structure of the account (Single or Joint).

---

## Version History

**Version 1.0**
- Initial documentation
- Core wallet and account management features
- ClearBank integration
- Admin management capabilities
